# ================================================
# Nginx Load Balancer – Configuração PRO (2025)
# ================================================

events {
    worker_connections  4096;      # era vazio → agora suporta muito mais tráfego
    multi_accept        on;
    use                 epoll;     # melhor performance em Linux
}

http {
    # ================ UPSTREAM (seus servidores) ================
    upstream backend_servers {
        # Estratégia inteligente: least_conn = manda para o menos ocupado
        least_conn;

        # Seus servidores (dê nomes amigáveis, facilita logs)
        server 172.31.0.37:80   max_fails=3 fail_timeout=30s weight=1;
        server 172.31.0.151:80  max_fails=3 fail_timeout=30s weight=1;
        server 172.31.0.149:80  max_fails=3 fail_timeout=30s weight=1;

        # Health check ativo (Nginx Plus ou open-source com módulo)
        # Se quiser health check passivo + ativo, posso adicionar
    }

    # ================ CONFIGURAÇÕES GLOBAIS ================
    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout   65s;
    keepalive_requests  100;

    types_hash_max_size 4096;
    server_tokens       off;                    # oculta versão do Nginx

    # Logs em JSON (muito melhor para ELK, Datadog, etc.)
    log_format json_combined escape=json
      '{'
        '"time":"$time_iso8601",'
        '"remote_addr":"$remote_addr",'
        '"request":"$request",'
        '"status":$status,'
        '"body_bytes_sent":$body_bytes_sent,'
        '"upstream_addr":"$upstream_addr",'
        '"upstream_response_time":$upstream_response_time,'
        '"request_time":$request_time'
      '}';

    access_log /var/log/nginx/access.log json_combined;
    error_log  /var/log/nginx/error.log warn;

    # Gzip + Brotli (compressão máxima)
    gzip            on;
    gzip_vary       on;
    gzip_proxied    any;
    gzip_comp_level 6;
    gzip_types      text/plain text/css application/json application/javascript application/xml+rss text/javascript;

    # ================ SERVER (load balancer) ================
    server {
        listen 4500 backlog=8192 reuseport;

        server_name _;  # aceita qualquer hostname

        # Timeout e limites de segurança
        client_max_body_size 50M;
        proxy_connect_timeout       10s;
        proxy_send_timeout          30s;
        proxy_read_timeout          30s;
        proxy_next_upstream         error timeout invalid_header http_500 http_502 http_503 http_504;

        location / {
            proxy_pass         http://backend_servers;
            proxy_set_header   Host              $host;
            proxy_set_header   X-Real-IP         $remote_addr;
            proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Proto $scheme;
            proxy_set_header   X-Forwarded-Prefix     /;

            # Cache de conexão com upstream (melhora performance)
            proxy_http_version 1.1;
            proxy_set_header   Connection "";
        }

        # Health check simples (acessível em /health)
        location /health {
            access_log off;
            return 200 "OK - Load Balancer Alive\n";
            add_header Content-Type text/plain;
        }

        # Página de status dos backends (opcional, mas muito útil)
        location /upstream_status {
            stub_status;
            allow 127.0.0.1;
            deny all;
        }
    }
}
